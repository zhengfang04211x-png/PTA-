# PTA期货交易策略回测系统

基于PX-石脑油价差"领先效应"的PTA期货交易策略回测系统（Streamlit网页版）

## 功能特点

- 📊 **交互式参数调整**：通过侧边栏滑块和输入框实时调整策略参数
- 🚀 **实时回测**：一键执行策略回测，即时查看结果
- 📈 **可视化展示**：净值曲线、价格走势、交易信号等图表展示
- 📋 **交易明细**：详细的交易记录和统计分析
- 💰 **盈亏分析**：盈亏分布、交易统计、绩效指标全面分析

## 策略说明

### 核心逻辑

1. **信号生成**：
   - 动态阈值：`1.5 × PX_ATR(20)` 替代固定阈值
   - 估值过滤器：做多时要求 `pta_margin < 450`，做空时要求 `pta_margin > 750`

2. **风险控制**：
   - ATR动态止损：`1.5 × ATR`
   - PX均线止损：PX价差收盘价跌破其5日均线时止损
   - 基差止盈：持仓超过7天且盈利>2%，基差连续3天走弱时提前平仓

3. **持仓管理**：
   - 固定持仓周期：15个交易日
   - 分级仓位：根据PTA生产利润动态调整仓位（加工费<350时放大1.5倍，>600时缩小至0.5倍）

## 安装与运行

### 本地运行

1. **安装依赖**

```bash
pip install -r requirements.txt
```

2. **运行应用**

```bash
streamlit run app.py
```

应用将在浏览器中自动打开，默认地址：`http://localhost:8501`

### 部署到 Streamlit Cloud

1. **准备GitHub仓库**
   - 将本仓库的所有文件上传到GitHub
   - 确保所有文件都在根目录

2. **部署步骤**
   - 访问 [Streamlit Cloud](https://streamlit.io/cloud)
   - 使用GitHub账号登录
   - 点击"New app"
   - 选择您的GitHub仓库
   - 设置 Main file path: `app.py`
   - 点击"Deploy"

3. **中文字体配置（重要）**
   - 代码已自动配置中文字体支持
   - 首次运行时，如果系统没有中文字体，代码会尝试自动下载 Noto Sans CJK SC 字体
   - 如果自动下载失败（网络限制），图表中的中文可能显示为方框
   - **解决方案**：
     - 方案A：等待首次运行完成，字体会自动下载并缓存
     - 方案B：如果仍有问题，可以在本地测试时确保字体正常工作，然后部署
     - 方案C：联系 Streamlit Cloud 支持，询问是否可以添加系统字体支持

## 数据格式要求

上传的CSV文件需要包含以下列：

### 必需列：
- `date` 或包含"日期"的列：日期数据（格式：YYYY-MM-DD）
- `futures_price` 或包含"期货价格"的列：PTA期货价格（**注意：是期货价格，不是现货价格**）
- `px_naphtha_spread` 或包含"PX石脑油价差"的列：PX-石脑油价差

### 可选列：
- `pta_margin` 或包含"加工费"的列：PTA加工费（用于估值过滤器）
- `basis` 或包含"基差"的列：基差数据（用于基差止盈）

### 示例数据格式

```csv
date,futures_price,px_naphtha_spread,pta_margin,basis
2019-01-04,6006.0,505.0,958.76,50.0
2019-01-07,6118.0,520.0,886.20,52.0
...
```

## 使用说明

1. **上传数据**：在侧边栏上传包含必要字段的CSV文件
2. **调整参数**：使用侧边栏的滑块和输入框调整策略参数
3. **执行回测**：点击"开始回测"按钮
4. **查看结果**：查看回测结果总览、净值曲线、价格走势、交易明细等

## 参数说明

### 信号生成参数
- **PX价差ATR周期**：计算PX价差ATR的周期（默认20天）
- **PX价差ATR倍数**：动态阈值倍数（默认1.5）

### 估值过滤器
- **做多估值阈值**：仅在pta_margin低于此值时做多（默认450元/吨）
- **做空估值阈值**：仅在pta_margin高于此值时做空（默认750元/吨）

### 交易执行参数
- **初始资金**：回测初始资金（默认100万元）
- **仓位比例**：每次交易的仓位比例（默认10%）
- **固定持仓周期**：持仓天数（默认15天）

### 风险控制参数
- **ATR止损倍数**：价格ATR止损倍数（默认1.5）
- **ATR计算周期**：价格ATR计算周期（默认14天）
- **PX均线止损周期**：PX价差均线周期（默认5天）

### 止盈参数
- **基差止盈盈利阈值**：触发基差止盈的最小盈利（默认2%）
- **基差连续走弱天数**：触发基差止盈的连续天数（默认3天）
- **基差止盈最小持仓天数**：触发基差止盈的最小持仓天数（默认7天）

### 分级仓位参数
- **低加工费阈值**：加工费低于此值时仓位放大1.5倍（默认350元/吨）
- **高加工费阈值**：加工费高于此值时仓位缩小至0.5倍（默认600元/吨）

## 文件结构

```
pta_strategy_github/
├── app.py              # Streamlit主应用
├── strategy.py         # 策略核心代码
├── requirements.txt    # Python依赖包
├── README.md          # 项目说明文档
└── .gitignore         # Git忽略文件
```

## 注意事项

1. **数据文件**：数据文件需要包含必要的列，否则会报错
2. **期货价格**：确保使用期货价格数据，不是现货价格
3. **可选字段**：如果数据中缺少`pta_margin`或`basis`列，相关功能会自动禁用
4. **数据量**：建议使用足够的历史数据进行回测，以获得更可靠的结果
5. **免责声明**：回测结果仅供参考，不构成投资建议

## 故障排除

### 应用无法启动
- 检查`requirements.txt`中的依赖是否正确
- 确认Python版本（推荐3.8+）

### 数据加载失败
- 检查数据文件格式是否正确
- 确认文件编码（推荐UTF-8）
- 确认包含必需的列名
- 确认使用的是期货价格，不是现货价格

### 图表显示异常
- 检查matplotlib字体设置
- 确认数据中是否有缺失值

## 许可证

MIT License

## 作者

PTA期货基本面量化分析

## 更新日志

### v1.0.0 (2026-01-29)
- 初始版本发布
- 支持交互式参数调整
- 支持实时回测和结果可视化
- 支持详细的交易分析和统计
- 支持动态止损、基差止盈、分级仓位等高级功能
